#!/usr/bin/env python
import sys
from urllib.request import urlopen
import datetime
from datetime import datetime, timezone
import json
import math

endpoints = ['Dimm', 'Mag1', 'Mag2']
endpoint_template = "http://weather.lco.cl/clima/weather/Magellan/PHP/grab{name}.php"

def retrieve_one(name):
    try:
        fh = urlopen(endpoint_template.format(name=name))
        points = json.load(fh)
        new_points = []
        for pt in points:
            new_points.append({
                'tm': pt['tm'],
                'dt': datetime.fromisoformat(pt['tm']).replace(tzinfo=timezone.utc),
                'el': float(pt['el']),
                'fw': float(pt['fw']),
            })
    except Exception as e:
        print(e, file=sys.stderr)
        pass
    new_points.sort(key=lambda x: x['tm'], reverse=True)
    return new_points[0]
    
def main():
    for ep in endpoints:
        point = retrieve_one(ep)
        with open(f"/tmp/{ep.lower()}.tsv", 'w') as fh:
            fh.write(f"datetime,fwhm,elevation\n")
            fh.write(f"{point['tm']},{point['fw']},{point['el']}\n")
    return 0

if __name__ == "__main__":
    sys.exit(main())
